# cbatrace

cbatrace (C Binding Api TRACE) is a utility script that is used to run a FDB client program (until it exits) in order to capture and record all its calls to the libfdb_c.so dynamic library.

cbatrace exploits the $LD_PRELOAD dynamic linker functionality to inject itself between the FDB client program and the libfdb_c.so library. It intercepts calls to the C binding APIs. It prints the name of the functions being called, along with the number of calls to each function.


## Usage

```bash
cbatrace [options] <program> [args...]

Options:
  -h            : Show this help.
  -c            : Count and show calls for each library call as it occurs.
                  The default is to only show a summary. 
  -o <file_name>: Write the trace output to the file file_name rather 
                  than to stdout.
```
## Examples
- Trace the C binding API calls when running test program 'fdb_c_txn_size_test'
  and show the summary of calls on stdout.

```bash
  > ./cbatrace ~/build/bin/fdb_c_txn_size_test
```

- Same as above, but also show every API call (as it occurs) with incremental 
  counts. Show the summary of calls on stdout.
```bash
  > ./cbatrace -c ~/build/bin/fdb_c_txn_size_test
```

- Same as above, but use file 'cbatrace.xml' to save the tracing result.
```bash
  > ./cbatrace-c -o /tmp/cbatrace.xml ~/build/bin/fdb_c_txn_size_test
```

The script producess a XML trace file. Its XML schema resembles the one used 
by the TraceEvent facility. 

### XML Trace File Example:
Note the summary section (i.e., XML fragment with attribute Type = "summary") at the end of the XML document. Ths trace file was produced by running cbatrace with -c option.
```bash
 <?xml version="1.0"?>
 <Trace>
   <Event Type="api" Name="fdb_transaction_on_error" Count="0" \>
   <Event Type="api" Name="fdb_transaction_watch" Count="0" \>
   ... 
   <Event Type="api" Name="fdb_get_client_version" Count="1" \>
   <Event Type="api" Name="fdb_create_database" Count="1" \>
   <Event Type="api" Name="fdb_database_create_transaction" Count="1" \>
   <Event Type="api" Name="fdb_transaction_set" Count="1" \>
   <Event Type="api" Name="fdb_transaction_set" Count="2" \>
   ... 
   <Event Type="api" Name="fdb_future_destroy" Count="1" \>
   <Event Type="api" Name="fdb_future_destroy" Count="2" \>
   <Event Type="api" Name="fdb_future_destroy" Count="3" \>
   <Event Type="api" Name="fdb_future_destroy" Count="4" \>
   ... 
   <Event Type="summary" Name="totals">
     <Event Type="api" Name="fdb_get_error" Count="0" \>
     <Event Type="api" Name="fdb_create_database" Count="1" \>
     <Event Type="api" Name="fdb_transaction_set" Count="2" \>
     ...
     <Event Type="api" Name="fdb_future_destroy" Count="4" \>
     <Event Type="api" Name="fdb_database_create_transaction" Count="1" \>
  </Event>
 </Trace>
```

## Bindingtester
- cbatrace is created to run as part of the bindingtester tests. cbatrace is disabled by default. To enable it you need to set environment variable 'CBATRACE_ENABLE' to value 1. Unsetting the env variable or setting it to a value different than 1 will disable the tracing.
- by default cbatrace only produces a summary of of FDB API calls, including the total number of call count. You can set environment variable '_CBATRACE_FLAGS' (with underscore as it is for an internal use only) to 1 to also trace individual API calls as they occur. In this case the trace will show each every API call with incremental counts. The env variable is unset by default. 



## libcbatracefdb_c.so
libcbatracefdb_c.so is the wrapper library that is used along with the LD_PRELOAD option to intercept and replace calls to the libfdb_c.so APIs. 
libcbatracefdb_c.so is created by compiling file cbatracefdb_c.g.cpp which overrides the definition of each and every function in libfdb_c.so.
cbatracefdb_c.g.cpp is a file generated by parsing file fdb_c.cpp using python script cbatraceSymbolify.py. 


## cbatraceSymbolify.py 
cbatraceSymbolify.py is a helper utility script for generating a cpp code file that is mainly used to create shared library libcbatracefdb_c.so as a wrapper of FDB C bindings shared library libfdb_c.so.
      
 ### Usage:

```python
python3 cbatraceSymbolify.py [options] fdb_c.cpp [fdb_c.h]

Options:
 -h             : Show this help
 -w (default)   : Generates a cpp code file with FDB types forward declarations 
                  and a list of wrapper functions, one for each FDB function 
                  from the fdb_c.cpp file. Input files fdb_c.h and fdb_c.cpp 
                  are mandatory.
 -s             : Produces an ordered list of C bindings Symbol names.
                  In this case fdb_c.h is optional.
 -o <file_name> : Spedifies the name of the output file.
                  Defaults to cbatracefdb_c.g.cpp or cbatracefdb_c.g.sym.
                 if the fdb_c.h is missing.
```    

### Examples:

```python
- Parse fdb_c.h and fdb_c.cpp to generate code file with default name
  cbatracefdb_c.g.cpp 
> python3 cbatraceSymbolify.py -w db_c.h fdb_c.cpp

Or simply
> python3 cbatraceSymbolify.py fdb_c.h fdb_c.cpp
    
- Same as above, but explicitly name the output file.
> python3 cbatraceSymbolify.py -o myWrapperFunctions.cpp fdb_c.h fdb_c.cpp 
    
- Parse fdb_c.cpp and generate a file containing the list of C Symbol names
> python3 cbatraceSymbolify.py -s fdb_c.cpp
    
- Same as above, but by explicitly naming the output file
> python3 cbatraceSymbolify.py -s -o myApiSymbols.sym fdb_c.cpp 
